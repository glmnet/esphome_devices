# Wiring
#     L (volt measure)   I current measure
#  L1  Brown              Green
#  L2  Red                Orange
#  L3  Black              Yellow
#
#  Neutral: Blue

esphome:
  name: eh-energia

esp8266:
  board: esp12e
  restore_from_flash: true

packages:
  wifi: !include ../package.wifi.yaml

captive_portal:

ota:

api:

logger:
  baud_rate: 0
  level: VERY_VERBOSE

substitutions:
  device_name: Energia

uart:
  baud_rate: 9600
  tx_pin: TX
  rx_pin: RX
  #stop_bits: 2

sensor:
  - platform: pzemac
    id: pzem1
    address: 1
    current:
      name: ${device_name} L1 Corriente
    voltage:
      name: ${device_name} L1 Voltage
    frequency:
      name: ${device_name} L1 Frecuencia
    energy:
      name: ${device_name} L1 Energía
      filters:
        - lambda: |-
            if (x < 40000000.0)
              return x;
            else
              return {};

    power:
      name: "${device_name} L1 Potencia"
    power_factor:
      name: ${device_name} L1 Factor de potencia
    update_interval: never

  - platform: pzemac
    id: pzem2
    address: 2
    current:
      name: ${device_name} L2 Corriente
    voltage:
      name: ${device_name} L2 Voltage
    frequency:
      name: ${device_name} L2 Frecuencia
    energy:
      name: ${device_name} L2 Energía
    power:
      name: "${device_name} L2 Potencia"
    power_factor:
      name: ${device_name} L2 Factor de potencia
    update_interval: never
  - platform: pzemac
    id: pzem3
    address: 3
    current:
      name: ${device_name} L3 Corriente
    voltage:
      name: ${device_name} L3 Voltage
    frequency:
      name: ${device_name} L3 Frecuencia
    energy:
      name: ${device_name} L3 Energía
    power:
      name: "${device_name} L3 Potencia"
    power_factor:
      name: ${device_name} L3 Factor de potencia
    update_interval: never

light:
  - platform: neopixelbus
    pin: GPIO2
    num_leds: 3
    variant: WS2812
    id: led_strip
    name: Energia Strip
    effects:
      - addressable_lambda:
          name: Voltage
          update_interval: 1s
          lambda: |-
            it[0] = Color(255, 127, 0);
            it[1] = Color(0, 127, 255);
            it[2] = Color(0, 127, 0);
      - addressable_lambda:
          name: Random
          update_interval: 1s
          lambda: |-
            it[0] = Color::random_color();
            it[1] = Color::random_color();
            it[2] = Color::random_color();

button:
  - platform: restart
    name: Energia Restart
  # - platform: template
  #   name: Reset PZEM
  #   on_press:
  #     then:
  #       - pzemac.reset_energy: pzem1

interval:
  - interval: 30s
    then:
      - component.update: pzem1
      - delay: 10s
      - component.update: pzem2
      - delay: 10s
      - component.update: pzem3
